<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instant LPJ Generator - Pro Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        /* Container Preview A4 */
        .a4-preview {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 10px 50px rgba(0,0,0,0.1);
            margin: 2rem auto;
            padding: 20mm 15mm;
            box-sizing: border-box;
            position: relative;
            color: black;
        }

        /* Hilangkan elemen saat cetak */
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .a4-preview {
                box-shadow: none !important;
                margin: 0 !important;
                width: 100% !important;
                padding: 10mm !important;
            }
        }

        /* Animasi */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        input, select, textarea {
            color: black !important;
            background-color: white !important;
        }
    </style>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^1.40.0",
        "lucide-react": "https://esm.sh/lucide-react@^0.563.0",
        "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
        "react/": "https://esm.sh/react@^19.2.4/",
        "react": "https://esm.sh/react@^19.2.4",
        "jspdf": "https://esm.sh/jspdf@^2.5.1",
        "html2canvas": "https://esm.sh/html2canvas@^1.4.1",
        "docx": "https://esm.sh/docx@^9.1.0",
        "file-saver": "https://esm.sh/file-saver@^2.0.5"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Plus, Trash2, PlusCircle, Loader2, Sparkles, RefreshCcw, 
            Camera, Layers, Download, FileText, User, FileDown, 
            FilePlus, Save, CheckCircle 
        } from 'lucide-react';
        import { jsPDF } from 'jspdf';
        import html2canvas from 'html2canvas';
        import { GoogleGenAI, Type } from "@google/genai";
        import { 
            Document, Packer, Paragraph, TextRun, AlignmentType, 
            Table, TableRow, TableCell, WidthType, BorderStyle, 
            ImageRun, UnderlineType, TableLayoutType 
        } from "docx";
        import saveAs from "file-saver";

        // --- UTILS ---
        const formatIDR = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = (e) => reject(e);
        });

        // --- AI SERVICE ---
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

        const App = () => {
            const [transactions, setTransactions] = useState([]);
            const [config, setConfig] = useState({
                eventName: '', organizationName: '', reportDate: new Date().toISOString().split('T')[0],
                chairpersonName: '', chairpersonTitle: 'Ketua Panitia',
                treasurerName: '', treasurerTitle: 'Bendahara',
                background: '', conclusion: ''
            });

            const [newTx, setNewTx] = useState({ date: new Date().toISOString().split('T')[0], description: '', type: 'Pengeluaran', amount: '' });
            const [isScanning, setIsScanning] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            const [isExporting, setIsExporting] = useState(false);
            const fileInputRef = useRef(null);
            const reportRef = useRef(null);

            // Persistence
            useEffect(() => {
                const saved = localStorage.getItem('lpj_v1_html');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    setTransactions(parsed.transactions || []);
                    setConfig(parsed.config || config);
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('lpj_v1_html', JSON.stringify({ config, transactions }));
            }, [config, transactions]);

            const handleAddTx = (e) => {
                e.preventDefault();
                if (!newTx.description || !newTx.amount) return;
                setTransactions([...transactions, { ...newTx, id: generateId(), amount: Number(newTx.amount), description: newTx.description.toUpperCase() }]);
                setNewTx({ ...newTx, description: '', amount: '' });
            };

            const handleScan = async (e) => {
                const file = e.target.files?.[0];
                if (!file || !process.env.API_KEY) return;
                setIsScanning(true);
                try {
                    const base64 = await fileToBase64(file);
                    const mimeType = base64.split(';')[0].split(':')[1];
                    const base64Data = base64.split(',')[1];
                    
                    const res = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: { parts: [{ inlineData: { mimeType, data: base64Data } }, { text: "Extract receipt details to JSON: { transactions: [{ date: 'YYYY-MM-DD', description: 'NAME', amount: number, type: 'Pengeluaran' }] }" }] },
                        config: { responseMimeType: "application/json" }
                    });
                    const data = JSON.parse(res.text);
                    if (data.transactions) {
                        setTransactions(prev => [...prev, ...data.transactions.map(t => ({ ...t, id: generateId(), receiptBase64: base64 }))]);
                    }
                } catch (err) { alert("Gagal scan nota."); }
                finally { setIsScanning(false); }
            };

            const generateAIContent = async () => {
                if (!process.env.API_KEY) return;
                setIsGenerating(true);
                try {
                    const prompt = `Buat narasi LPJ untuk: ${config.eventName}. Organisasi: ${config.organizationName}. Format JSON: { background: "...", conclusion: "..." }`;
                    const res = await ai.models.generateContent({ model: 'gemini-3-flash-preview', contents: prompt, config: { responseMimeType: "application/json" } });
                    const data = JSON.parse(res.text);
                    setConfig({ ...config, background: data.background, conclusion: data.conclusion });
                } catch (e) { alert("Gagal generate narasi."); }
                finally { setIsGenerating(false); }
            };

            const handleDownloadPDF = async () => {
                setIsExporting(true);
                const canvas = await html2canvas(reportRef.current, { scale: 2 });
                const pdf = new jsPDF('p', 'mm', 'a4');
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, (canvas.height * 210) / canvas.width);
                pdf.save(`LPJ_${config.eventName || 'Export'}.pdf`);
                setIsExporting(false);
            };

            const totalIn = transactions.filter(t => t.type === 'Pemasukan').reduce((s, t) => s + t.amount, 0);
            const totalOut = transactions.filter(t => t.type === 'Pengeluaran').reduce((s, t) => s + t.amount, 0);
            const balance = totalIn - totalOut;

            const inputClass = "w-full p-3 border-2 border-slate-200 rounded-xl bg-white text-black focus:border-blue-500 outline-none transition-all";

            return React.createElement('div', { className: 'min-h-screen pb-20' },
                // Navbar
                React.createElement('nav', { className: 'bg-slate-900 text-white p-4 shadow-xl sticky top-0 z-50 no-print' },
                    React.createElement('div', { className: 'container mx-auto flex justify-between items-center max-w-6xl' },
                        React.createElement('div', { className: 'flex items-center gap-3' },
                            React.createElement('div', { className: 'bg-blue-600 p-2 rounded-lg' }, React.createElement(FileText, { className: 'w-6 h-6' })),
                            React.createElement('h1', { className: 'text-xl font-black uppercase tracking-tighter' }, 'LPJ ', React.createElement('span', { className: 'text-blue-500' }, 'INSTANT'))
                        ),
                        React.createElement('div', { className: 'flex gap-2' },
                            React.createElement('button', { onClick: handleDownloadPDF, className: 'bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl font-bold flex items-center gap-2 text-sm shadow-lg' }, 
                                isExporting ? React.createElement(Loader2, { className: 'animate-spin w-4 h-4' }) : React.createElement(Download, { className: 'w-4 h-4' }), 'PDF'
                            ),
                            React.createElement('button', { onClick: () => window.print(), className: 'bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-xl font-bold flex items-center gap-2 text-sm shadow-lg' }, React.createElement(Plus, { className: 'w-4 h-4' }), 'CETAK')
                        )
                    )
                ),

                // Main Content
                React.createElement('div', { className: 'container mx-auto px-4 max-w-6xl py-8 space-y-8 no-print' },
                    // Dashboard Stats
                    React.createElement('section', { className: 'grid grid-cols-1 md:grid-cols-3 gap-6' },
                        React.createElement('div', { className: 'bg-white border-b-8 border-emerald-500 p-6 rounded-3xl shadow-sm' }, 
                            React.createElement('p', { className: 'text-slate-500 text-xs font-bold uppercase tracking-widest' }, 'Pemasukan (+)'),
                            React.createElement('p', { className: 'text-3xl font-black text-emerald-600' }, formatIDR(totalIn))
                        ),
                        React.createElement('div', { className: 'bg-white border-b-8 border-rose-500 p-6 rounded-3xl shadow-sm' },
                            React.createElement('p', { className: 'text-slate-500 text-xs font-bold uppercase tracking-widest' }, 'Pengeluaran (-)'),
                            React.createElement('p', { className: 'text-3xl font-black text-rose-600' }, formatIDR(totalOut))
                        ),
                        React.createElement('div', { className: 'bg-slate-900 text-white p-6 rounded-3xl shadow-xl' },
                            React.createElement('p', { className: 'text-blue-300 text-xs font-bold uppercase tracking-widest' }, 'Saldo Akhir'),
                            React.createElement('p', { className: 'text-3xl font-black' }, formatIDR(balance))
                        )
                    ),

                    React.createElement('div', { className: 'grid grid-cols-1 lg:grid-cols-3 gap-8' },
                        React.createElement('div', { className: 'lg:col-span-2 space-y-8' },
                            // Data Kegiatan
                            React.createElement('section', { className: 'bg-white p-8 rounded-3xl shadow-sm border border-slate-200' },
                                React.createElement('h2', { className: 'text-xl font-bold mb-6 flex items-center gap-3' }, React.createElement(Layers, { className: 'text-blue-600 w-6 h-6' }), '1. Data Kegiatan'),
                                React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                                    React.createElement('div', { className: 'md:col-span-2' },
                                        React.createElement('label', { className: 'text-[10px] font-bold text-slate-400 uppercase ml-1' }, 'Nama Kegiatan'),
                                        React.createElement('input', { type: 'text', value: config.eventName, onChange: (e) => setConfig({...config, eventName: e.target.value}), className: inputClass, placeholder: 'Contoh: Rapat Kerja 2024' })
                                    ),
                                    React.createElement('div', null,
                                        React.createElement('label', { className: 'text-[10px] font-bold text-slate-400 uppercase ml-1' }, 'Organisasi'),
                                        React.createElement('input', { type: 'text', value: config.organizationName, onChange: (e) => setConfig({...config, organizationName: e.target.value}), className: inputClass, placeholder: 'Nama Organisasi' })
                                    ),
                                    React.createElement('div', null,
                                        React.createElement('label', { className: 'text-[10px] font-bold text-slate-400 uppercase ml-1' }, 'Tanggal'),
                                        React.createElement('input', { type: 'date', value: config.reportDate, onChange: (e) => setConfig({...config, reportDate: e.target.value}), className: inputClass })
                                    ),
                                    React.createElement('div', null,
                                        React.createElement('input', { type: 'text', value: config.chairpersonTitle, onChange: (e) => setConfig({...config, chairpersonTitle: e.target.value}), className: 'w-full mb-1 text-xs font-bold uppercase text-slate-400 bg-transparent outline-none' }),
                                        React.createElement('input', { type: 'text', value: config.chairpersonName, onChange: (e) => setConfig({...config, chairpersonName: e.target.value}), className: inputClass, placeholder: 'Nama Ketua' })
                                    ),
                                    React.createElement('div', null,
                                        React.createElement('input', { type: 'text', value: config.treasurerTitle, onChange: (e) => setConfig({...config, treasurerTitle: e.target.value}), className: 'w-full mb-1 text-xs font-bold uppercase text-slate-400 bg-transparent outline-none' }),
                                        React.createElement('input', { type: 'text', value: config.treasurerName, onChange: (e) => setConfig({...config, treasurerName: e.target.value}), className: inputClass, placeholder: 'Nama Bendahara' })
                                    )
                                )
                            ),

                            // Detail Keuangan
                            React.createElement('section', { className: 'bg-white p-8 rounded-3xl shadow-sm border border-slate-200' },
                                React.createElement('div', { className: 'flex justify-between items-center mb-6' },
                                    React.createElement('h2', { className: 'text-xl font-bold flex items-center gap-3' }, React.createElement(PlusCircle, { className: 'text-blue-600 w-6 h-6' }), '2. Detail Keuangan'),
                                    React.createElement('div', null,
                                        React.createElement('input', { type: 'file', ref: fileInputRef, className: 'hidden', accept: 'image/*', onChange: handleScan }),
                                        React.createElement('button', { onClick: () => fileInputRef.current.click(), disabled: isScanning, className: 'bg-blue-600 text-white px-4 py-2 rounded-xl font-bold text-xs flex items-center gap-2 hover:bg-blue-700 shadow-md' },
                                            isScanning ? React.createElement(Loader2, { className: 'animate-spin w-4 h-4' }) : React.createElement(Camera, { className: 'w-4 h-4' }), 'SCAN NOTA (AI)'
                                        )
                                    )
                                ),
                                React.createElement('form', { onSubmit: handleAddTx, className: 'grid grid-cols-1 md:grid-cols-12 gap-2 mb-6 bg-slate-50 p-4 rounded-2xl border-2 border-dashed border-slate-200' },
                                    React.createElement('div', { className: 'md:col-span-3' }, React.createElement('input', { type: 'date', value: newTx.date, onChange: (e) => setNewTx({...newTx, date: e.target.value}), className: 'w-full p-2 rounded-lg border-2 border-white bg-white text-black' })),
                                    React.createElement('div', { className: 'md:col-span-4' }, React.createElement('input', { type: 'text', placeholder: 'Keterangan', value: newTx.description, onChange: (e) => setNewTx({...newTx, description: e.target.value}), className: 'w-full p-2 rounded-lg border-2 border-white bg-white text-black' })),
                                    React.createElement('div', { className: 'md:col-span-3' }, React.createElement('input', { type: 'number', placeholder: 'Nominal', value: newTx.amount, onChange: (e) => setNewTx({...newTx, amount: e.target.value}), className: 'w-full p-2 rounded-lg border-2 border-white bg-white text-black' })),
                                    React.createElement('div', { className: 'md:col-span-2' }, React.createElement('button', { type: 'submit', className: 'w-full p-2 bg-slate-900 text-white font-bold rounded-lg hover:bg-blue-600' }, 'Tambah')),
                                    React.createElement('div', { className: 'md:col-span-12' }, 
                                        React.createElement('select', { value: newTx.type, onChange: (e) => setNewTx({...newTx, type: e.target.value}), className: 'w-full p-2 text-xs font-bold uppercase text-slate-500 bg-white' },
                                            React.createElement('option', { value: 'Pengeluaran' }, 'PENGELUARAN (-)'),
                                            React.createElement('option', { value: 'Pemasukan' }, 'PEMASUKAN (+)')
                                        )
                                    )
                                ),
                                React.createElement('div', { className: 'overflow-hidden rounded-2xl border border-slate-100' },
                                    React.createElement('table', { className: 'w-full text-left bg-white' },
                                        React.createElement('thead', { className: 'bg-slate-50 text-[10px] font-black text-slate-400 uppercase border-b' },
                                            React.createElement('tr', null, 
                                                React.createElement('th', { className: 'p-4' }, 'TGL'),
                                                React.createElement('th', { className: 'p-4' }, 'URAIAN'),
                                                React.createElement('th', { className: 'p-4 text-right' }, 'NOMINAL'),
                                                React.createElement('th', { className: 'p-4' })
                                            )
                                        ),
                                        React.createElement('tbody', { className: 'divide-y divide-slate-50 text-sm' },
                                            transactions.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: 4, className: 'p-10 text-center text-slate-300 italic' }, 'Belum ada data.')) :
                                            transactions.map(t => React.createElement('tr', { key: t.id, className: 'hover:bg-slate-50' },
                                                React.createElement('td', { className: 'p-4 font-mono text-slate-400' }, t.date),
                                                React.createElement('td', { className: 'p-4 font-bold text-black uppercase' }, t.description),
                                                React.createElement('td', { className: `p-4 text-right font-black ${t.type === 'Pemasukan' ? 'text-emerald-600' : 'text-rose-600'}` }, formatIDR(t.amount)),
                                                React.createElement('td', { className: 'p-4 text-right' }, 
                                                    React.createElement('button', { onClick: () => setTransactions(transactions.filter(x => x.id !== t.id)), className: 'text-slate-300 hover:text-red-500' }, React.createElement(Trash2, { className: 'w-4 h-4' }))
                                                )
                                            ))
                                        )
                                    )
                                )
                            )
                        ),

                        // AI Sidebar
                        React.createElement('aside', { className: 'space-y-6' },
                            React.createElement('section', { className: 'bg-white p-8 rounded-3xl shadow-sm border border-slate-200' },
                                React.createElement('h2', { className: 'text-xl font-bold mb-4 flex items-center gap-2 text-purple-700' }, React.createElement(Sparkles, { className: 'w-6 h-6' }), 'Narasi AI'),
                                React.createElement('div', { className: 'space-y-4' },
                                    React.createElement('textarea', { value: config.background, onChange: (e) => setConfig({...config, background: e.target.value}), className: 'w-full h-32 p-3 bg-slate-50 rounded-xl border-none text-sm resize-none focus:ring-2 focus:ring-purple-200 text-black', placeholder: 'Latar belakang...' }),
                                    React.createElement('textarea', { value: config.conclusion, onChange: (e) => setConfig({...config, conclusion: e.target.value}), className: 'w-full h-32 p-3 bg-slate-50 rounded-xl border-none text-sm resize-none focus:ring-2 focus:ring-purple-200 text-black', placeholder: 'Kesimpulan...' }),
                                    React.createElement('button', { onClick: generateAIContent, disabled: isGenerating, className: 'w-full py-3 bg-purple-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-purple-700 shadow-lg' },
                                        isGenerating ? React.createElement(Loader2, { className: 'animate-spin' }) : React.createElement(Sparkles, { className: 'w-4 h-4' }), 'GENERATE NARASI'
                                    )
                                )
                            )
                        )
                    )
                ),

                // Preview A4
                React.createElement('div', { className: 'bg-slate-800 py-10 flex justify-center overflow-x-auto min-h-screen' },
                    React.createElement('div', { ref: reportRef, className: 'a4-preview flex flex-col' },
                        React.createElement('div', { className: 'text-center border-b-4 border-double border-black pb-8 mb-10' },
                            React.createElement('h1', { className: 'text-xl font-bold uppercase underline' }, 'LAPORAN PERTANGGUNGJAWABAN (LPJ) KEUANGAN'),
                            React.createElement('h2', { className: 'text-4xl font-black text-blue-900 mt-2 uppercase' }, config.eventName || '[NAMA KEGIATAN]'),
                            React.createElement('p', { className: 'text-sm font-bold bg-slate-100 inline-block px-4 py-1 rounded-full mt-4 border border-slate-200' }, 'TANGGAL LAPORAN: ', config.reportDate)
                        ),
                        React.createElement('div', { className: 'mb-8 px-4' },
                            React.createElement('h3', { className: 'font-bold border-l-8 border-blue-900 pl-4 mb-4' }, 'I. PENDAHULUAN'),
                            React.createElement('p', { className: 'text-sm text-justify whitespace-pre-wrap' }, config.background || 'Belum diisi.')
                        ),
                        React.createElement('div', { className: 'mb-8 px-4' },
                            React.createElement('h3', { className: 'font-bold border-l-8 border-blue-900 pl-4 mb-6' }, 'II. RINCIAN ANGGARAN KEUANGAN'),
                            React.createElement('table', { className: 'w-full border-collapse border-2 border-black text-xs' },
                                React.createElement('thead', null,
                                    React.createElement('tr', { className: 'bg-slate-100' },
                                        React.createElement('th', { className: 'border-2 border-black p-2 text-center w-10' }, 'No'),
                                        React.createElement('th', { className: 'border-2 border-black p-2 text-center w-28' }, 'Tanggal'),
                                        React.createElement('th', { className: 'border-2 border-black p-2 text-left' }, 'Deskripsi Transaksi'),
                                        React.createElement('th', { className: 'border-2 border-black p-2 text-right w-32' }, 'Debit (+)'),
                                        React.createElement('th', { className: 'border-2 border-black p-2 text-right w-32' }, 'Kredit (-)')
                                    )
                                ),
                                React.createElement('tbody', null,
                                    transactions.length > 0 ? transactions.map((t, i) => React.createElement('tr', { key: t.id },
                                        React.createElement('td', { className: 'border border-black p-2 text-center' }, i + 1),
                                        React.createElement('td', { className: 'border border-black p-2 text-center font-mono' }, t.date),
                                        React.createElement('td', { className: 'border border-black p-2 font-bold uppercase' }, t.description),
                                        React.createElement('td', { className: 'border border-black p-2 text-right' }, t.type === 'Pemasukan' ? formatIDR(t.amount) : '-'),
                                        React.createElement('td', { className: 'border border-black p-2 text-right' }, t.type === 'Pengeluaran' ? formatIDR(t.amount) : '-')
                                    )) : React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: 'p-10 text-center border border-black italic text-slate-400' }, 'Belum ada data.'))
                                ),
                                React.createElement('tfoot', { className: 'font-bold border-2 border-black' },
                                    React.createElement('tr', { className: 'bg-blue-900 text-white' },
                                        React.createElement('td', { colSpan: 3, className: 'p-4 text-right uppercase text-xs' }, 'Total Saldo Panitia'),
                                        React.createElement('td', { colSpan: 2, className: 'p-4 text-center text-xl font-black' }, formatIDR(balance))
                                    )
                                )
                            )
                        ),
                        React.createElement('div', { className: 'mb-12 px-4' },
                            React.createElement('h3', { className: 'font-bold border-l-8 border-blue-900 pl-4 mb-4' }, 'III. PENUTUP'),
                            React.createElement('p', { className: 'text-sm text-justify whitespace-pre-wrap' }, config.conclusion || 'Belum diisi.')
                        ),
                        React.createElement('div', { className: 'mt-auto pt-10 pb-12 grid grid-cols-2 text-center' },
                            React.createElement('div', null,
                                React.createElement('p', { className: 'font-bold text-sm mb-20 uppercase' }, config.chairpersonTitle),
                                React.createElement('p', { className: 'font-black text-lg border-b-2 border-black inline-block px-4' }, config.chairpersonName || '....................')
                            ),
                            React.createElement('div', null,
                                React.createElement('p', { className: 'font-bold text-sm mb-20 uppercase' }, config.treasurerTitle),
                                React.createElement('p', { className: 'font-black text-lg border-b-2 border-black inline-block px-4' }, config.treasurerName || '....................')
                            )
                        )
                    )
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
